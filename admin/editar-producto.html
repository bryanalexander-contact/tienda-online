<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Editar Producto - Admin</title>
<link rel="stylesheet" href="../css/style.css">
</head>
<body>
<div class="admin-container">
  <aside class="sidebar">
    <h2>Panel Productos</h2>
    <ul>
      <li><a href="mostrar-productos.html">Mostrar Productos</a></li>
      <li><a href="nuevo-producto.html">Nuevo Producto</a></li>
    </ul>
  </aside>

  <main class="admin-main">
    <h1>Editar Producto</h1>
    <form id="form-editar-producto">
      <label for="codigo">Código Producto</label>
      <input type="text" id="codigo" name="codigo" minlength="3" required>

      <label for="nombre">Nombre</label>
      <input type="text" id="nombre" name="nombre" maxlength="100" required>

      <label for="descripcion">Descripción</label>
      <textarea id="descripcion" name="descripcion" maxlength="500"></textarea>

      <label for="precio">Precio</label>
      <input type="number" id="precio" name="precio" min="0" step="0.01" required>

      <label for="stock">Stock</label>
      <input type="number" id="stock" name="stock" min="0" step="1" required>

      <label for="stockCritico">Stock Crítico</label>
      <input type="number" id="stockCritico" name="stockCritico" min="0" step="1">

      <label for="categoria">Categoría</label>
      <select id="categoria" name="categoria" required>
        <option value="" disabled selected>Seleccione categoría</option>
        <option value="Electrónica">Electrónica</option>
        <option value="Ropa">Ropa</option>
        <option value="Hogar">Hogar</option>
      </select>

      <label for="imagenArchivo">Imagen (archivo)</label>
      <input type="file" id="imagenArchivo" accept="image/*">

      <label for="imagenUrl">O ingresa URL de imagen</label>
      <input type="text" id="imagenUrl" placeholder="https://...">

      <button type="submit">Guardar Cambios</button>
    </form>
  </main>
</div>

<script src="../scripts/productos.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('form-editar-producto');
  const idEditar = parseInt(localStorage.getItem('editarProductoId'));
  const producto = obtenerProducto(idEditar);

  if (!producto) {
    alert('Producto no encontrado');
    window.location.href = 'mostrar-productos.html';
    return;
  }

  // Rellenar formulario con datos existentes
  form.codigo.value = producto.codigo;
  form.nombre.value = producto.nombre;
  form.descripcion.value = producto.descripcion || '';
  form.precio.value = producto.precio;
  form.stock.value = producto.stock;
  form.stockCritico.value = producto.stockCritico || '';
  form.categoria.value = producto.categoria;
  document.getElementById('imagenUrl').value = producto.imagen || '';

  form.addEventListener('submit', e => {
    e.preventDefault();

    const archivo = document.getElementById('imagenArchivo').files[0];
    const url = document.getElementById('imagenUrl').value.trim();

    function actualizarConImagen(imagenFinal) {
      const datos = {
        codigo: form.codigo.value.trim(),
        nombre: form.nombre.value.trim(),
        descripcion: form.descripcion.value.trim(),
        precio: parseFloat(form.precio.value),
        stock: parseInt(form.stock.value),
        stockCritico: parseInt(form.stockCritico.value) || null,
        categoria: form.categoria.value,
        imagen: imagenFinal
      };
      actualizarProducto(idEditar, datos);
      alert('Producto actualizado!');
      window.location.href = 'mostrar-productos.html';
    }

    if (archivo) {
      const reader = new FileReader();
      reader.onload = () => actualizarConImagen(reader.result);
      reader.readAsDataURL(archivo);
    } else {
      actualizarConImagen(url || '');
    }
  });
});
</script>
</body>
</html>
